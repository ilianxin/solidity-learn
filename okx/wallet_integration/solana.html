<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Solana DApp</title>
</head>

<body>
    <div>
        <button class="connectSolanaButton btn">Connect Solana</button>
        <label class="account"></label>
    </div>
    <div>
        <button class="signButton btn">Sign Message</button>
        <label class="sigMsg"></label>
    </div>
    <div>
        <label>连接状态</label>
        <label class="connectStatus"></label>
    </div>
</body>
<script>
    const connectSolanaButton = document.querySelector('.connectSolanaButton');
    const signButton = document.querySelector('.signButton');

    let account = '';

    // step1 创建连接
    connectSolanaButton.addEventListener('click', async () => {
        try {
            const provider = window.okxwallet.solana;
            const resp = await provider.connect();
            console.log(resp.publicKey.toString());
            account = resp.publicKey.toString();
            document.querySelector('.account').textContent = account;

        } catch (error) {
            console.log(error);
            // { code: 4001, message: "User rejected the request."}
        }
    });

    // step2 消息签名
    signButton.addEventListener('click', async () => {
        try {
            const message = `GM, Solana ~ I am OKX`;
            const encodedMessage = new TextEncoder().encode(message);
            const signedMessage = await window.okxwallet.solana.signMessage(encodedMessage, "utf8");
            console.log(signedMessage.signature);
            document.querySelector('.sigMsg').textContent = signedMessage.signature;

        } catch (error) {
            // see "Errors"
        }
    });

    // step3 事件监听
    window.okxwallet.solana.on('connect', () => {
        console.log('connected');
        document.querySelector('.connectStatus').textContent = 'connected';
    })

    window.okxwallet.solana.on("disconnect", () => {
        console.log("disconnected!")
        document.querySelector('.connectStatus').textContent = 'disconnected';
    });

    window.okxwallet.solana.on('accountChanged', (publicKey) => {
        if (publicKey) {
            // Set new public key and continue as usual
            console.log(`Switched to account ${publicKey.toBase58()}`);
            document.querySelector('.connectStatus').textContent = `Switched to account ${publicKey.toBase58()}`;
        } else {
            // Attempt to reconnect to OKX wallet
            window.okxwallet.solana.connect().catch((error) => {
                // Handle connection failure
            });
        }
    });
</script>

</html>