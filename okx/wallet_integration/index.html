<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>okx wallet integration</title>
</head>

<body>
    <div>
        <label class="okxwallet"></label>
    </div>
    <div>
        <button class="connectEthereumButton">Connect to Ethereum</button>
        <label class="account"></label>
    </div>
    <div>
        <button class="switchChainButton btn">Switch Chain</button>
        ChainId: <label class="chainId"></label>
    </div>
    <div>
        <button class="addToken">Add Token</button>
    </div>
    <div>
        <button class="signTransactionButton btn">Send Transaction</button>
        <label class="txHash"></label>
    </div>
    <div>
        <button class="signMessageButton btn">Sign Message</button>
        <label class="sigMsg"></label>
    </div>
</body>
<script>
    if (typeof window.okxwallet !== 'undefined') {
        console.log('OKX is installed!');
        document.querySelector('.okxwallet').textContent = 'OKX is installed!';
    }

    const connectEthereumButton = document.querySelector('.connectEthereumButton');
    const switchChainButton = document.querySelector('.switchChainButton');
    const signTransactionButton = document.querySelector('.signTransactionButton');
    const signMessageButton = document.querySelector('.signMessageButton');

    let accounts = [];

    // step1 创建连接
    connectEthereumButton.addEventListener('click', async () => {
        //Will Start the OKX extension
        accounts = await okxwallet.request({ method: 'eth_requestAccounts' });
        console.log("accounts: ", accounts);
        document.querySelector('.account').textContent = accounts[0];
    });

    // okxwallet.on('accountsChanged', handler: (accounts: Array<string>) => void);

    // step2 监听地址变化#
    okxwallet.on('accountsChanged', (accounts) => {
        // Handle accounts changed event
        console.log('Accounts changed:', accounts);
        document.querySelector('.account').textContent = accounts[0];
    });

    // step3 监听网络变化#
    window.addEventListener('load', async () => {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        console.log("chainId: ", chainId);
        document.querySelector('.chainId').textContent = chainId;
        // window.ethereum.on('chainChanged', handleChainChanged);
        okxwallet.on('chainChanged', handleChainChanged);
    });
    function handleChainChanged(chainId) {
        // We recommend reloading the page, unless you must do otherwise.
        console.log("new chainId: ", chainId);
        // window.location.reload();
        document.querySelector('.chainId').textContent = chainId;
    }

    // step4 切换链
    switchChainButton.addEventListener('click', async () => {
        try {
            const chainId = okxwallet.chainId === "0x42" ? "0xaa36a7" : "0x42";
            // sepolia 11155111
            await okxwallet.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: chainId }]
            });
        } catch (switchError) {
            // This error code indicates that the chain has not been added to OKX Wallet.
            if (error.code === 4902) {
                try {
                    await okxwallet.request({
                        method: "wallet_addEthereumChain",
                        params: [{ chainId: "0xf00", rpcUrl: "https://..." /* ... */ }]
                    });
                } catch (addError) {
                    // handle "add" error
                }
            }
            // handle other "switch" errors
        }
    });

    // step5 添加代币
    const addTokenButton = document.querySelector('.addToken');
    addTokenButton.addEventListener('click', async () => {
        const tokenAddress = '0x8B5977Eb4B204a93fD153216Be4a66fB7Fc71bd8';
        const tokenSymbol = 'MTK';
        const tokenDecimals = 18;
        const tokenImage = 'https://www.shutterstock.com/image-vector/web-30-typography-on-futuristic-260nw-2126710844.jpg';
        try {
            // wasAdded is a boolean. Like any RPC method, an error may be thrown.
            const wasAdded = await okxwallet.request({
                method: 'wallet_watchAsset',
                params: {
                    type: 'ERC20', // Initially only supports ERC20, but eventually more!
                    options: {
                        address: tokenAddress, // The address that the token is at.
                        symbol: tokenSymbol, // A ticker symbol or shorthand, up to 5 chars.
                        decimals: tokenDecimals, // The number of decimals in the token
                        image: tokenImage, // A string url of the token logo
                    },
                },
            });

            if (wasAdded) {
                console.log('Thanks for your interest!');
            } else {
                console.log('Your loss!');
            }
        } catch (error) {
            console.log(error);
        }
    });

    // step6 发送交易
    signTransactionButton.addEventListener('click', () => {
        okxwallet
            .request({
                method: 'eth_sendTransaction',
                params: [
                    {
                        from: accounts[0],
                        to: '0x5CB8896Db7Bf13DE6A6EA362866288e577e4F6C5',
                        value: '0x1BC16D674EC80000',
                        gasPrice: '0x09184e72a000',
                        gas: '0x2710',
                    },
                ],
            })
            .then((txHash) => {
                console.log(txHash);
                document.querySelector('.txHash').textContent = txHash;
            })
            .catch((error) => console.error);
    });

    // step7: 签名消息
    signMessageButton.addEventListener('click', () => {
        okxwallet
            .request({
                method: 'eth_sign',
                params: [accounts[0], "0xdeadbeaf"],
            })
            .then((res) => {
                console.log(res);
                document.querySelector('.sigMsg').textContent = res;
            })
            .catch((error) => console.error);
    });
</script>

</html>